import streamlit as st
import google.generativeai as genai
import textwrap  # For wrapping long text

# --- API Key Setup (Replace with your actual keys) ---
API_KEYS = st.secrets["API_KEYS"]
# --- Helper Functions ---
def call_gemini_api(prompt):
    for api_key in API_KEYS:
        try:
            genai.configure(api_key=api_key)
            model = genai.GenerativeModel("gemini-pro")
            response = model.generate_content(prompt)
            return response.text.strip()
        except Exception as e:
            error_message = str(e)
            if "insufficient_quota" in error_message or "Quota exceeded" in error_message:
                continue
            else:
                return f"‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: {error_message}"
    return "‚ö†Ô∏è API ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏°‡∏î‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì"

def process_menus(response_text):
    menu_list = response_text.split("üçΩÔ∏è ‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà")
    menu_list = [menu.strip() for menu in menu_list if menu.strip()]
    if not menu_list:
        menu_list = response_text.split("\n- ")
        menu_list = [menu.strip() for menu in menu_list if menu.strip()]
    if not menu_list:
        menu_list = response_text.split("\n‚Ä¢ ")
        menu_list = [menu.strip() for menu in menu_list if menu.strip()]
    return menu_list

# --- Custom CSS ---
st.markdown("""
<style>
/* Global Styles */
body {
    font-family: 'Kanit', sans-serif; /* Modern Thai font */
}

.stApp {
    background-color: #f0f2f6;  /* Light gray background */
    background-image: url("https://www.transparenttextures.com/patterns/subtle-white-feathers.png"); /*Subtle Background Pattern*/

}

/* Header */
.title {
    color: #2c3e50;
    text-align: center;
    padding: 1rem 0;
    font-size: 2.5rem; /* Larger title */
    font-weight: 600;  /* Semi-bold */
}

/* Mode Selection */
.mode-selection {
    margin-bottom: 2rem;
    border-radius: 10px;
    padding: 10px;
    background-color: white;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

/* Input Sections */
.input-section {
    background-color: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
}

/* Input Fields */
.stTextInput, .stSelectbox, .stSlider, .stRadio, .stNumberInput {
    margin-bottom: 10px;
}
.stTextArea>div>div>textarea{
    border-color:#3498db;
}

/* Buttons */
.stButton>button {
    background-color: #3498db; /* Blue */
    color: white;
    border: none;
    border-radius: 20px; /* Rounded buttons */
    padding: 10px 24px;
    font-size: 1.1rem;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); /* Subtle shadow */
    width: 100%; /* Make buttons full width */
}

.stButton>button:hover {
    background-color: #2980b9; /* Darker blue on hover */
    transform: translateY(-2px); /* Slight lift on hover */
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.stButton>button:active {
    transform: translateY(0); /* Reset position on click */
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

/* Menu Columns */
.menu-column {
    background-color: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s ease; /* Smooth transition */
    border: 2px solid transparent; /* Add a border */
}

.menu-column:hover {
    transform: scale(1.03); /* Slightly enlarge on hover */
    border-color: #3498db;
}

.menu-column h3 {
    color: #3498db; /* Blue heading */
    margin-bottom: 10px;
    font-size: 1.4rem;
}

.menu-item {
    font-size: 1rem;
    line-height: 1.6;
    color: #4a4a4a; /* Dark gray text */
}

/* Expander */
.st-expanderHeader {
    font-size: 1.2rem;
    font-weight: 500; /* Slightly bolder expander header */
}

/* About Section */
.about-section {
    background-color: #e0e0e0;
    border-radius: 10px;
    padding: 20px;
    margin-top: 20px;
}
.about-section ul {
    list-style: none; /* Remove bullet points */
    padding: 0;

}

.about-section li {
    margin-bottom: .5rem;
}

/* Spinners */
.st-cf {
    color: #3498db !important; /* Make spinners blue */
}

</style>
""", unsafe_allow_html=True)

# --- App UI ---
st.markdown("<h1 class='title'>üçΩÔ∏è Smart Cooking App üòé</h1>", unsafe_allow_html=True)

with st.container(border=True):
    option = st.radio("üîπ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î:", ["‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏ô‡∏π‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö", "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏°‡∏ô‡∏π‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠"],
                    horizontal=True, key="mode_select")

if option == "‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏ô‡∏π‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö":
    st.subheader("‚ú® ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ö‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á")

    with st.expander("üìù ‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì", expanded=True):
        ingredients = st.text_area("‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏à‡∏∏‡∏•‡∏†‡∏≤‡∏Ñ):",
                                    placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏Ç‡πà, ‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ö, ‡∏ú‡∏±‡∏Å‡∏Å‡∏≤‡∏î...",
                                    height=120)

    with st.expander("‚öôÔ∏è ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì", expanded=False):
        col1, col2 = st.columns(2)
        with col1:
            num_ingredients = st.number_input("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏´‡∏•‡∏±‡∏Å", min_value=1, max_value=20, value=3, step=1)
            category = st.selectbox("‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏≤‡∏´‡∏≤‡∏£",
                                    ["‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ", "‡∏°‡∏±‡∏á‡∏™‡∏ß‡∏¥‡∏£‡∏±‡∏ï‡∏¥", "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Ñ‡∏•‡∏µ‡∏ô", "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢", "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô", "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å"])
            calories = st.slider("‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (kcal)", 100, 1500, 500, step=50)

        with col2:
            difficulty = st.radio("‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å", ["‡∏á‡πà‡∏≤‡∏¢", "‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á", "‡∏¢‡∏≤‡∏Å"], horizontal=True)
            cook_time = st.slider("‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£ (‡∏ô‡∏≤‡∏ó‡∏µ)", 5, 180, 30, step=5)

    if st.button("üç≥ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏ô‡∏π", use_container_width=True):
        if ingredients:
            prompt = (f"‡∏â‡∏±‡∏ô‡∏°‡∏µ: {ingredients} ({num_ingredients} ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏´‡∏•‡∏±‡∏Å) "
                      f"‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏°‡∏ô‡∏π {category} ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô {cook_time} ‡∏ô‡∏≤‡∏ó‡∏µ "
                      f"‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì {calories} kcal ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å {difficulty} "
                      f"‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏≥‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ‡πÄ‡∏™‡∏ô‡∏≠ 3 ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ 'üçΩÔ∏è ‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà'")
            with st.spinner("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏≠‡∏£‡πà‡∏≠‡∏¢‡πÜ..."):
                menu_list = process_menus(call_gemini_api(prompt))

            if menu_list:
                st.subheader("üßë‚Äçüç≥ ‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:")
                cols = st.columns(3)
                for i, menu in enumerate(menu_list[:3]):
                    with cols[i]:
                        st.markdown(f"<div class='menu-column'><h3>üçΩÔ∏è ‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà {i+1}</h3><p class='menu-item'>{menu}</p></div>", unsafe_allow_html=True)
            else:
                st.warning("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤")
        else:
            st.warning("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì")

elif option == "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏°‡∏ô‡∏π‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠":
    st.subheader("‚ú® ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì")

    with st.expander("‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤", expanded=True):
        col1, col2 = st.columns(2)
        with col1:
            country = st.selectbox("‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®", ["‡πÑ‡∏ó‡∏¢", "‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô", "‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ‡πÉ‡∏ï‡πâ", "‡∏™‡∏´‡∏£‡∏±‡∏ê‡∏≠‡πÄ‡∏°‡∏£‡∏¥‡∏Å‡∏≤", "‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©", "‡∏ù‡∏£‡∏±‡πà‡∏á‡πÄ‡∏®‡∏™", "‡πÄ‡∏¢‡∏≠‡∏£‡∏°‡∏ô‡∏µ"])
            category = st.selectbox("‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏≤‡∏´‡∏≤‡∏£", ["‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢", "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô", "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ", "‡∏ü‡∏≤‡∏™‡∏ï‡πå‡∏ü‡∏π‡πâ‡∏î", "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û"])
        with col2:
            taste = st.radio("‡∏£‡∏™‡∏ä‡∏≤‡∏ï‡∏¥", ["‡πÄ‡∏ú‡πá‡∏î", "‡∏´‡∏ß‡∏≤‡∏ô", "‡πÄ‡∏Ñ‡πá‡∏°", "‡πÄ‡∏õ‡∏£‡∏µ‡πâ‡∏¢‡∏ß"], horizontal=True)
            budget = st.radio("‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì", ["‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 100 ‡∏ö‡∏≤‡∏ó", "100 - 300 ‡∏ö‡∏≤‡∏ó", "‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 300 ‡∏ö‡∏≤‡∏ó"], horizontal=True)

    if st.button("üîé ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏°‡∏ô‡∏π", use_container_width=True):
        prompt = (f"‡∏â‡∏±‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£ {category} ‡∏£‡∏™‡∏ä‡∏≤‡∏ï‡∏¥ {taste} ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì {budget} ‡πÉ‡∏ô {country} "
                  f"‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ 3 ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π {category} ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡∏≤‡∏¢‡πÉ‡∏ô {country} ‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ 'üçΩÔ∏è ‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà'")

        with st.spinner("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î..."):
            menu_list = process_menus(call_gemini_api(prompt))

        if menu_list:
            st.subheader("üßë‚Äçüç≥ ‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:")
            cols = st.columns(3)
            for i, menu in enumerate(menu_list[:3]):
                with cols[i]:
                     st.markdown(f"<div class='menu-column'><h3>üçΩÔ∏è ‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà {i+1}</h3><p class='menu-item'>{menu}</p></div>", unsafe_allow_html=True)
        else:
            st.warning("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏°‡∏ô‡∏π ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á")

# --- About Section ---
st.markdown("---")
if st.button("üìú ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏û‡∏±‡∏í‡∏ô‡∏≤", use_container_width=True):
    with st.expander("ü§ù ‡∏û‡∏ö‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô"):
        st.markdown("""
        <div class='about-section'>
        <ul>
        <li><strong>1. ‡∏ô‡∏≤‡∏¢ ‡∏Å‡∏±‡∏•‡∏õ‡∏û‡∏§‡∏Å‡∏©‡πå ‡∏ß‡∏¥‡πÄ‡∏ä‡∏µ‡∏¢‡∏£‡∏£‡∏±‡∏ï‡∏ô‡πå</strong> - <em>‡∏ä‡∏±‡πâ‡∏ô 6/13 ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 3(‡∏Ñ‡∏ô‡πÅ‡∏ö‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö‡∏≠‡∏¥‡πÜ)</em></li>
        <li><strong>2. ‡∏ô‡∏≤‡∏¢ ‡∏ò‡∏µ‡∏£‡∏≤‡∏ò‡∏£ ‡∏°‡∏∏‡∏Å‡∏î‡∏≤‡πÄ‡∏û‡∏ä‡∏£‡∏£‡∏±‡∏ï‡∏ô‡πå</strong> - <em>‡∏ä‡∏±‡πâ‡∏ô 6/13 ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 13</em></li>
        <li><strong>3. ‡∏ô‡∏≤‡∏¢ ‡∏≠‡∏†‡∏¥‡∏ß‡∏¥‡∏ä‡∏ç‡πå ‡∏≠‡∏î‡∏∏‡∏•‡∏ò‡∏£‡∏£‡∏°‡∏ß‡∏¥‡∏ó‡∏¢‡πå</strong> - <em>‡∏ä‡∏±‡πâ‡∏ô 6/13 ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 28</em></li>
        <li><strong>4. ‡∏ô‡∏≤‡∏¢ ‡∏õ‡∏±‡∏ì‡∏ì‡∏ß‡∏¥‡∏ä‡∏ç‡πå ‡∏´‡∏•‡∏µ‡∏Å‡∏†‡∏±‡∏¢</strong> - <em>‡∏ä‡∏±‡πâ‡∏ô 6/13 ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 29</em></li>
        </ul>
        </div>
        """, unsafe_allow_html=True)
